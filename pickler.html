<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Pickler Combinators
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="F# Functional IO Library"/>
    <meta name="author" content="Phil Curzon"/>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="/NovelIO/content/style.css" />
    <script type="text/javascript" src="/NovelIO/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://github.com/TheInnerLight/NovelIO">github page</a></li>
        </ul>
        <h3 class="muted"><a href="/NovelIO/index.html">NovelIO</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Pickler-Combinators" class="anchor" href="#Pickler-Combinators">Pickler Combinators</a></h1>
<p>Pickler combinators are a concept described by Andrew J. Kennedy (<a href="http://research.microsoft.com/pubs/64036/picklercombinators.pdf).">http://research.microsoft.com/pubs/64036/picklercombinators.pdf).</a></p>
<p>Their purpose is to present a serialisation/deserialiation mechanism that grants the developer explicit control over their serialisation format while avoiding the requirement to write lots of tedious, error prone code.</p>
<p>Pickler combinators operate by allowing the construction of pickler/unpickler pairs (hereafter called PUs from brevity) which excapsulate the serialisation process.</p>
<h2><a name="PU-primitives" class="anchor" href="#PU-primitives">PU primitives</a></h2>
<p>PU primitives are provided to handle simple data types and more complicated PUs can be constructed by combining these PUs using combinator functions.</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs4', 6)" onmouseover="showTip(event, 'fs4', 6)" class="i">intPU</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 7)" onmouseover="showTip(event, 'fs5', 7)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 8)" onmouseover="showTip(event, 'fs6', 8)" class="i">intPU</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs7', 9)" onmouseover="showTip(event, 'fs7', 9)" class="i">floatPU</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 10)" onmouseover="showTip(event, 'fs5', 10)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 11)" onmouseover="showTip(event, 'fs8', 11)" class="i">float32PU</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs9', 12)" onmouseover="showTip(event, 'fs9', 12)" class="i">asciiPU</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 13)" onmouseover="showTip(event, 'fs5', 13)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 14)" onmouseover="showTip(event, 'fs10', 14)" class="i">asciiPU</span>
</code></pre>
<p>These are just a few examples of the primitive PUs defined in this library.  These PUs can be used to serialise (pickle) or deserialise (unpickle) values of the type associated with their PU to and from their binary representations.</p>
<p>The beauty of pickler combinators is that the same PU can be used to transform data in both directions.</p>
<h2><a name="Endianness" class="anchor" href="#Endianness">Endianness</a></h2>
<p>The default PUs for each datatype, such as <code>intPU</code> will pickle in the endianness of the current platform.  It's also possible to specify endianness for each primitive.</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs11', 15)" onmouseover="showTip(event, 'fs11', 15)" class="i">littleEndianIntPU</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 16)" onmouseover="showTip(event, 'fs5', 16)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs12', 17)" onmouseover="showTip(event, 'fs12', 17)" class="t">LittleEndian</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs13', 18)" onmouseover="showTip(event, 'fs13', 18)" class="i">intPU</span> <span class="c">// little endian int PU</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs14', 19)" onmouseover="showTip(event, 'fs14', 19)" class="i">bigEndianUtf32PU</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 20)" onmouseover="showTip(event, 'fs5', 20)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs15', 21)" onmouseover="showTip(event, 'fs15', 21)" class="t">BigEndian</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 22)" onmouseover="showTip(event, 'fs16', 22)" class="i">utf32PU</span> <span class="c">// big endian utf-32 PU</span>
</code></pre>
<p>Little endian PUs are found in the <code>LittleEndian</code> submodule and big endian PUs are found in the <code>BigEndian</code> submodule.  Note that both of these modules also contain <code>list</code> and <code>array</code> combinator PUs, that's because these combinators prefix a length to the output and that length needs a defined endianness.</p>
<h2><a name="Running-PUs" class="anchor" href="#Running-PUs">Running PUs</a></h2>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs17', 23)" onmouseover="showTip(event, 'fs17', 23)" class="i">bytes</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 24)" onmouseover="showTip(event, 'fs5', 24)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs18', 25)" onmouseover="showTip(event, 'fs18', 25)" class="f">pickle</span> (<span onmouseout="hideTip(event, 'fs5', 26)" onmouseover="showTip(event, 'fs5', 26)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 27)" onmouseover="showTip(event, 'fs6', 27)" class="i">intPU</span>) <span class="n">64</span> <span class="c">// convert the int value 64 into a byte array</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs19', 28)" onmouseover="showTip(event, 'fs19', 28)" class="i">intR</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 29)" onmouseover="showTip(event, 'fs5', 29)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs20', 30)" onmouseover="showTip(event, 'fs20', 30)" class="f">unpickle</span> (<span onmouseout="hideTip(event, 'fs5', 31)" onmouseover="showTip(event, 'fs5', 31)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 32)" onmouseover="showTip(event, 'fs6', 32)" class="i">intPU</span>) <span onmouseout="hideTip(event, 'fs17', 33)" onmouseover="showTip(event, 'fs17', 33)" class="i">bytes</span> <span class="c">// convert the byte array back into an int</span>
</code></pre>
<p>Here we use the pickle function to transform the int 64 into its binary representation and then transform it back using the unpickle function.</p>
<h2><a name="Tuple-combinators" class="anchor" href="#Tuple-combinators">Tuple combinators</a></h2>
<p>A variety of tuple combinators are provided to allow the pickling/unpickling of tuples.  These can be constructed, for example, as follows:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs21', 34)" onmouseover="showTip(event, 'fs21', 34)" class="i">intUtf8PU</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 35)" onmouseover="showTip(event, 'fs5', 35)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs22', 36)" onmouseover="showTip(event, 'fs22', 36)" class="f">tuple2</span> <span onmouseout="hideTip(event, 'fs5', 37)" onmouseover="showTip(event, 'fs5', 37)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 38)" onmouseover="showTip(event, 'fs6', 38)" class="i">intPU</span> <span onmouseout="hideTip(event, 'fs5', 39)" onmouseover="showTip(event, 'fs5', 39)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs23', 40)" onmouseover="showTip(event, 'fs23', 40)" class="i">utf8PU</span>
</code></pre>
<p>The <code>tuple2</code> function is simply supplied with two PUs and it constructs a combined pickler.</p>
<p><code>tuple3</code> and <code>tuple4</code> functions are also provided, allowing the construction of more complex PUs.</p>
<h2><a name="Wrapping-PUs" class="anchor" href="#Wrapping-PUs">Wrapping PUs</a></h2>
<p>Rather than constructing data from tuples, we may wish to pickle/unpickle custom data types.  It is possible to do this by providing a function which constructs and deconstructs this custom data-type.</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="c">/// Unit of pounds sterling</span>
[&lt;<span onmouseout="hideTip(event, 'fs24', 41)" onmouseover="showTip(event, 'fs24', 41)" class="t">Measure</span>&gt;] <span class="k">type</span> <span onmouseout="hideTip(event, 'fs25', 42)" onmouseover="showTip(event, 'fs25', 42)" class="t">GBP</span>

<span class="c">/// A product with an associated price</span>
<span class="k">type</span> <span onmouseout="hideTip(event, 'fs26', 43)" onmouseover="showTip(event, 'fs26', 43)" class="t">Product</span> <span class="o">=</span> {<span onmouseout="hideTip(event, 'fs27', 44)" onmouseover="showTip(event, 'fs27', 44)" class="i">ProductName</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs28', 45)" onmouseover="showTip(event, 'fs28', 45)" class="t">string</span>; <span onmouseout="hideTip(event, 'fs29', 46)" onmouseover="showTip(event, 'fs29', 46)" class="i">ProductPrice</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs30', 47)" onmouseover="showTip(event, 'fs30', 47)" class="t">decimal</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs25', 48)" onmouseover="showTip(event, 'fs25', 48)" class="t">GBP</span><span class="o">&gt;</span>}

<span class="c">/// A pickler/unpickler pair (PU) for products</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs31', 49)" onmouseover="showTip(event, 'fs31', 49)" class="i">productPU</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs32', 50)" onmouseover="showTip(event, 'fs32', 50)" class="i">nameDecPU</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 51)" onmouseover="showTip(event, 'fs5', 51)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs22', 52)" onmouseover="showTip(event, 'fs22', 52)" class="f">tuple2</span> <span onmouseout="hideTip(event, 'fs5', 53)" onmouseover="showTip(event, 'fs5', 53)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs23', 54)" onmouseover="showTip(event, 'fs23', 54)" class="i">utf8PU</span> <span onmouseout="hideTip(event, 'fs5', 55)" onmouseover="showTip(event, 'fs5', 55)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs33', 56)" onmouseover="showTip(event, 'fs33', 56)" class="i">decimalPU</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs34', 57)" onmouseover="showTip(event, 'fs34', 57)" class="f">toProd</span> (<span onmouseout="hideTip(event, 'fs35', 58)" onmouseover="showTip(event, 'fs35', 58)" class="i">name</span>,<span onmouseout="hideTip(event, 'fs36', 59)" onmouseover="showTip(event, 'fs36', 59)" class="i">price</span>) <span class="o">=</span> {<span class="i">ProductName</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs35', 60)" onmouseover="showTip(event, 'fs35', 60)" class="i">name</span>; <span class="i">ProductPrice</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs36', 61)" onmouseover="showTip(event, 'fs36', 61)" class="i">price</span><span class="o">*</span><span class="n">1.0M</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs25', 62)" onmouseover="showTip(event, 'fs25', 62)" class="t">GBP</span><span class="o">&gt;</span>} <span class="c">// tuple to product</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs37', 63)" onmouseover="showTip(event, 'fs37', 63)" class="f">fromProd</span> <span onmouseout="hideTip(event, 'fs38', 64)" onmouseover="showTip(event, 'fs38', 64)" class="i">prod</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs38', 65)" onmouseover="showTip(event, 'fs38', 65)" class="i">prod</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs27', 66)" onmouseover="showTip(event, 'fs27', 66)" class="i">ProductName</span>, <span onmouseout="hideTip(event, 'fs30', 67)" onmouseover="showTip(event, 'fs30', 67)" class="f">decimal</span> <span onmouseout="hideTip(event, 'fs38', 68)" onmouseover="showTip(event, 'fs38', 68)" class="i">prod</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs29', 69)" onmouseover="showTip(event, 'fs29', 69)" class="i">ProductPrice</span> <span class="c">// product to tuple</span>
    <span onmouseout="hideTip(event, 'fs5', 70)" onmouseover="showTip(event, 'fs5', 70)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs39', 71)" onmouseover="showTip(event, 'fs39', 71)" class="f">wrap</span> (<span onmouseout="hideTip(event, 'fs34', 72)" onmouseover="showTip(event, 'fs34', 72)" class="f">toProd</span>, <span onmouseout="hideTip(event, 'fs37', 73)" onmouseover="showTip(event, 'fs37', 73)" class="f">fromProd</span>) <span onmouseout="hideTip(event, 'fs32', 74)" onmouseover="showTip(event, 'fs32', 74)" class="i">nameDecPU</span>
</code></pre>
<p>Here, the custom record type contains a string and a decimal with a unit of measure so we define a tuple PU which will pickle/unpickle the underlying data and provide functions that construct and deconstruct data from that form.</p>
<p>Data can then easily be read into or written from our custom data type.</p>
<h2><a name="List-and-Array-combinators" class="anchor" href="#List-and-Array-combinators">List and Array combinators</a></h2>
<p>The list and array combinators take a PU of type 'a and produce a pickler that pickles the corresponding collection type.</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs40', 75)" onmouseover="showTip(event, 'fs40', 75)" class="i">intArrayPU</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 76)" onmouseover="showTip(event, 'fs5', 76)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs41', 77)" onmouseover="showTip(event, 'fs41', 77)" class="f">array</span> <span onmouseout="hideTip(event, 'fs5', 78)" onmouseover="showTip(event, 'fs5', 78)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 79)" onmouseover="showTip(event, 'fs6', 79)" class="i">intPU</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs42', 80)" onmouseover="showTip(event, 'fs42', 80)" class="i">floatListPU</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 81)" onmouseover="showTip(event, 'fs5', 81)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs43', 82)" onmouseover="showTip(event, 'fs43', 82)" class="f">list</span> <span onmouseout="hideTip(event, 'fs5', 83)" onmouseover="showTip(event, 'fs5', 83)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 84)" onmouseover="showTip(event, 'fs6', 84)" class="i">intPU</span>
</code></pre>
<p>It is, of course, possible to combine several of these combinators to produce complicated list PUs, e.g.:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs44', 85)" onmouseover="showTip(event, 'fs44', 85)" class="i">complexPickler</span> <span class="o">=</span> 
    <span onmouseout="hideTip(event, 'fs5', 86)" onmouseover="showTip(event, 'fs5', 86)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs43', 87)" onmouseover="showTip(event, 'fs43', 87)" class="f">list</span> 
        (<span onmouseout="hideTip(event, 'fs5', 88)" onmouseover="showTip(event, 'fs5', 88)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs45', 89)" onmouseover="showTip(event, 'fs45', 89)" class="f">tuple3</span> 
            <span onmouseout="hideTip(event, 'fs5', 90)" onmouseover="showTip(event, 'fs5', 90)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 91)" onmouseover="showTip(event, 'fs10', 91)" class="i">asciiPU</span> <span onmouseout="hideTip(event, 'fs5', 92)" onmouseover="showTip(event, 'fs5', 92)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs46', 93)" onmouseover="showTip(event, 'fs46', 93)" class="i">floatPU</span> <span onmouseout="hideTip(event, 'fs5', 94)" onmouseover="showTip(event, 'fs5', 94)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 95)" onmouseover="showTip(event, 'fs6', 95)" class="i">intPU</span>)
</code></pre>
<h2><a name="Fixed-length-string-encodings" class="anchor" href="#Fixed-length-string-encodings">Fixed length string encodings</a></h2>
<p>Fixed length strings can be encoded either in bulk, as a complete string, or character by character.  Take ASCII, for example:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs47', 96)" onmouseover="showTip(event, 'fs47', 96)" class="i">asciiStringPU</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 97)" onmouseover="showTip(event, 'fs5', 97)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 98)" onmouseover="showTip(event, 'fs10', 98)" class="i">asciiPU</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs48', 99)" onmouseover="showTip(event, 'fs48', 99)" class="i">asciiCharPU</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 100)" onmouseover="showTip(event, 'fs5', 100)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs49', 101)" onmouseover="showTip(event, 'fs49', 101)" class="i">asciiCharPU</span>
</code></pre>
<p>Char PUs can also be combined using the 'lengthPrefixed' and 'nullTerminated' combinators to build derived string PUs.</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs50', 102)" onmouseover="showTip(event, 'fs50', 102)" class="i">lengthPrefixedAscii</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 103)" onmouseover="showTip(event, 'fs5', 103)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs51', 104)" onmouseover="showTip(event, 'fs51', 104)" class="f">lengthPrefixed</span> <span onmouseout="hideTip(event, 'fs5', 105)" onmouseover="showTip(event, 'fs5', 105)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs49', 106)" onmouseover="showTip(event, 'fs49', 106)" class="i">asciiCharPU</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs52', 107)" onmouseover="showTip(event, 'fs52', 107)" class="i">nullTermAscii</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 108)" onmouseover="showTip(event, 'fs5', 108)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs53', 109)" onmouseover="showTip(event, 'fs53', 109)" class="f">nullTerminated</span> <span onmouseout="hideTip(event, 'fs5', 110)" onmouseover="showTip(event, 'fs5', 110)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs49', 111)" onmouseover="showTip(event, 'fs49', 111)" class="i">asciiCharPU</span>
</code></pre>
<p>The 'lengthPrefixed' combinator encodes the number of characters in the string before the list of characters while the 'nullTerminated' encodes a 'NULL' character as the final item in the string.</p>
<h2><a name="Variable-length-string-encodings" class="anchor" href="#Variable-length-string-encodings">Variable length string encodings</a></h2>
<p>Variable length strings (such as UTF-8) cannot be encoded character by character so only the bulk string option exists.</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs54', 112)" onmouseover="showTip(event, 'fs54', 112)" class="i">utf8PU</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 113)" onmouseover="showTip(event, 'fs5', 113)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs23', 114)" onmouseover="showTip(event, 'fs23', 114)" class="i">utf8PU</span>
</code></pre>
<h2><a name="Incremental-Pickling" class="anchor" href="#Incremental-Pickling">Incremental Pickling</a></h2>
<p>In many cases, especially when dealing with large binary files, it could be desirable to not have to convert back and forth between extremely large byte arrays, indeed this approach might not be viable due to available memory.</p>
<p>In this case, we can use incremental pickling to read/write as part of the pickling process.  Unlike the simple conversion process shown above, this action is effectful so is encapsulated within <code>IO</code>.</p>
<p>This process is quite simple, instead of using the <code>pickle</code> and <code>unpickle</code> functions, we use the <code>pickleIncr</code> and <code>unpickleIncr</code> functions.  These simply take the additional argument of a <code>BinaryHandle</code> upon which they will act.</p>
<p>Example of incremental unpickling:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs55', 115)" onmouseover="showTip(event, 'fs55', 115)" class="i">io</span> {
    <span class="k">let!</span> <span onmouseout="hideTip(event, 'fs56', 116)" onmouseover="showTip(event, 'fs56', 116)" class="i">handle</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 117)" onmouseover="showTip(event, 'fs57', 117)" class="t">File</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs58', 118)" onmouseover="showTip(event, 'fs58', 118)" class="f">openBinaryHandle</span> <span onmouseout="hideTip(event, 'fs59', 119)" onmouseover="showTip(event, 'fs59', 119)" class="t">FileMode</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs60', 120)" onmouseover="showTip(event, 'fs60', 120)" class="p">Open</span> <span onmouseout="hideTip(event, 'fs61', 121)" onmouseover="showTip(event, 'fs61', 121)" class="t">FileAccess</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs62', 122)" onmouseover="showTip(event, 'fs62', 122)" class="p">Read</span> (<span onmouseout="hideTip(event, 'fs57', 123)" onmouseover="showTip(event, 'fs57', 123)" class="t">File</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs63', 124)" onmouseover="showTip(event, 'fs63', 124)" class="f">assumeValidFilename</span> <span class="s">&quot;test.txt&quot;</span>)
    <span class="k">return!</span> <span onmouseout="hideTip(event, 'fs5', 125)" onmouseover="showTip(event, 'fs5', 125)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs64', 126)" onmouseover="showTip(event, 'fs64', 126)" class="f">unpickleIncr</span> <span onmouseout="hideTip(event, 'fs44', 127)" onmouseover="showTip(event, 'fs44', 127)" class="i">complexPickler</span> <span onmouseout="hideTip(event, 'fs56', 128)" onmouseover="showTip(event, 'fs56', 128)" class="i">handle</span>
}
</code></pre>
<p>Example of incremental pickling:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs55', 129)" onmouseover="showTip(event, 'fs55', 129)" class="i">io</span> {
    <span class="k">let!</span> <span onmouseout="hideTip(event, 'fs56', 130)" onmouseover="showTip(event, 'fs56', 130)" class="i">handle</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 131)" onmouseover="showTip(event, 'fs57', 131)" class="t">File</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs58', 132)" onmouseover="showTip(event, 'fs58', 132)" class="f">openBinaryHandle</span> <span onmouseout="hideTip(event, 'fs59', 133)" onmouseover="showTip(event, 'fs59', 133)" class="t">FileMode</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs65', 134)" onmouseover="showTip(event, 'fs65', 134)" class="p">Create</span> <span onmouseout="hideTip(event, 'fs61', 135)" onmouseover="showTip(event, 'fs61', 135)" class="t">FileAccess</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs66', 136)" onmouseover="showTip(event, 'fs66', 136)" class="p">Write</span> (<span onmouseout="hideTip(event, 'fs57', 137)" onmouseover="showTip(event, 'fs57', 137)" class="t">File</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs63', 138)" onmouseover="showTip(event, 'fs63', 138)" class="f">assumeValidFilename</span> <span class="s">&quot;test.txt&quot;</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs67', 139)" onmouseover="showTip(event, 'fs67', 139)" class="i">data</span> <span class="o">=</span> [(<span class="s">&quot;A&quot;</span>, <span class="n">7.5</span>, <span class="n">16</span>); (<span class="s">&quot;B&quot;</span>, <span class="n">7.5</span>, <span class="n">1701</span>)]
    <span class="k">return!</span> <span onmouseout="hideTip(event, 'fs5', 140)" onmouseover="showTip(event, 'fs5', 140)" class="t">BinaryPickler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs68', 141)" onmouseover="showTip(event, 'fs68', 141)" class="f">pickleIncr</span> <span onmouseout="hideTip(event, 'fs44', 142)" onmouseover="showTip(event, 'fs44', 142)" class="i">complexPickler</span> <span onmouseout="hideTip(event, 'fs56', 143)" onmouseover="showTip(event, 'fs56', 143)" class="i">handle</span> <span onmouseout="hideTip(event, 'fs67', 144)" onmouseover="showTip(event, 'fs67', 144)" class="i">data</span>
}
</code></pre>

<div class="tip" id="fs1">namespace NovelFS</div>
<div class="tip" id="fs2">namespace NovelFS.NovelIO</div>
<div class="tip" id="fs3">namespace NovelFS.NovelIO.BinaryPickler</div>
<div class="tip" id="fs4">val intPU : BinaryPU&lt;int32&gt;<br /><br />Full name: Pickler.intPU</div>
<div class="tip" id="fs5">Multiple items<br />module BinaryPickler<br /><br />from NovelFS.NovelIO.BinaryPickler<br /><br />--------------------<br />namespace NovelFS.NovelIO.BinaryPickler</div>
<div class="tip" id="fs6">val intPU : BinaryPU&lt;int32&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.intPU</div>
<div class="tip" id="fs7">val floatPU : BinaryPU&lt;float32&gt;<br /><br />Full name: Pickler.floatPU</div>
<div class="tip" id="fs8">val float32PU : BinaryPU&lt;float32&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.float32PU</div>
<div class="tip" id="fs9">val asciiPU : BinaryPU&lt;string&gt;<br /><br />Full name: Pickler.asciiPU</div>
<div class="tip" id="fs10">val asciiPU : BinaryPU&lt;string&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.asciiPU</div>
<div class="tip" id="fs11">val littleEndianIntPU : BinaryPU&lt;int32&gt;<br /><br />Full name: Pickler.littleEndianIntPU</div>
<div class="tip" id="fs12">module LittleEndian<br /><br />from NovelFS.NovelIO.BinaryPickler.BinaryPickler</div>
<div class="tip" id="fs13">val intPU : BinaryPU&lt;int32&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.LittleEndian.intPU</div>
<div class="tip" id="fs14">val bigEndianUtf32PU : BinaryPU&lt;string&gt;<br /><br />Full name: Pickler.bigEndianUtf32PU</div>
<div class="tip" id="fs15">module BigEndian<br /><br />from NovelFS.NovelIO.BinaryPickler.BinaryPickler</div>
<div class="tip" id="fs16">val utf32PU : BinaryPU&lt;string&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.BigEndian.utf32PU</div>
<div class="tip" id="fs17">val bytes : byte []<br /><br />Full name: Pickler.bytes</div>
<div class="tip" id="fs18">val pickle : pu:BinaryPU&lt;&#39;a&gt; -&gt; value:&#39;a -&gt; byte []<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.pickle</div>
<div class="tip" id="fs19">val intR : int32<br /><br />Full name: Pickler.intR</div>
<div class="tip" id="fs20">val unpickle : pu:BinaryPU&lt;&#39;a&gt; -&gt; array:byte array -&gt; &#39;a<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.unpickle</div>
<div class="tip" id="fs21">val intUtf8PU : BinaryPU&lt;int32 * string&gt;<br /><br />Full name: Pickler.intUtf8PU</div>
<div class="tip" id="fs22">val tuple2 : pa:BinaryPU&lt;&#39;a&gt; -&gt; pb:BinaryPU&lt;&#39;b&gt; -&gt; BinaryPU&lt;&#39;a * &#39;b&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.tuple2</div>
<div class="tip" id="fs23">val utf8PU : BinaryPU&lt;string&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.utf8PU</div>
<div class="tip" id="fs24">Multiple items<br />type MeasureAttribute =<br />&#160;&#160;inherit Attribute<br />&#160;&#160;new : unit -&gt; MeasureAttribute<br /><br />Full name: Microsoft.FSharp.Core.MeasureAttribute<br /><br />--------------------<br />new : unit -&gt; MeasureAttribute</div>
<div class="tip" id="fs25">[&lt;Measure&gt;]<br />type GBP<br /><br />Full name: Pickler.GBP<br /><em><br /><br />&#160;Unit of pounds sterling</em></div>
<div class="tip" id="fs26">type Product =<br />&#160;&#160;{ProductName: string;<br />&#160;&#160;&#160;ProductPrice: decimal&lt;GBP&gt;;}<br /><br />Full name: Pickler.Product<br /><em><br /><br />&#160;A product with an associated price</em></div>
<div class="tip" id="fs27">Product.ProductName: string</div>
<div class="tip" id="fs28">Multiple items<br />val string : value:&#39;T -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.Operators.string<br /><br />--------------------<br />type string = System.String<br /><br />Full name: Microsoft.FSharp.Core.string</div>
<div class="tip" id="fs29">Product.ProductPrice: decimal&lt;GBP&gt;</div>
<div class="tip" id="fs30">Multiple items<br />val decimal : value:&#39;T -&gt; decimal (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.decimal<br /><br />--------------------<br />type decimal = System.Decimal<br /><br />Full name: Microsoft.FSharp.Core.decimal<br /><br />--------------------<br />type decimal&lt;&#39;Measure&gt; = decimal<br /><br />Full name: Microsoft.FSharp.Core.decimal&lt;_&gt;</div>
<div class="tip" id="fs31">val productPU : BinaryPU&lt;Product&gt;<br /><br />Full name: Pickler.productPU<br /><em><br /><br />&#160;A pickler/unpickler pair (PU) for products</em></div>
<div class="tip" id="fs32">val nameDecPU : BinaryPU&lt;string * System.Decimal&gt;</div>
<div class="tip" id="fs33">val decimalPU : BinaryPU&lt;System.Decimal&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.decimalPU</div>
<div class="tip" id="fs34">val toProd : (string * decimal -&gt; Product)</div>
<div class="tip" id="fs35">val name : string</div>
<div class="tip" id="fs36">val price : decimal</div>
<div class="tip" id="fs37">val fromProd : (Product -&gt; string * decimal)</div>
<div class="tip" id="fs38">val prod : Product</div>
<div class="tip" id="fs39">val wrap : fab:(&#39;a -&gt; &#39;b) * fba:(&#39;b -&gt; &#39;a) -&gt; pa:BinaryPU&lt;&#39;a&gt; -&gt; BinaryPU&lt;&#39;b&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.wrap</div>
<div class="tip" id="fs40">val intArrayPU : BinaryPU&lt;int32 []&gt;<br /><br />Full name: Pickler.intArrayPU</div>
<div class="tip" id="fs41">val array : pa:BinaryPU&lt;&#39;a&gt; -&gt; BinaryPU&lt;&#39;a []&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.array</div>
<div class="tip" id="fs42">val floatListPU : BinaryPU&lt;int32 list&gt;<br /><br />Full name: Pickler.floatListPU</div>
<div class="tip" id="fs43">val list : pa:BinaryPU&lt;&#39;a&gt; -&gt; BinaryPU&lt;&#39;a list&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.list</div>
<div class="tip" id="fs44">val complexPickler : BinaryPU&lt;(string * float * int32) list&gt;<br /><br />Full name: Pickler.complexPickler</div>
<div class="tip" id="fs45">val tuple3 : pa:BinaryPU&lt;&#39;a&gt; -&gt; pb:BinaryPU&lt;&#39;b&gt; -&gt; pc:BinaryPU&lt;&#39;c&gt; -&gt; BinaryPU&lt;&#39;a * &#39;b * &#39;c&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.tuple3</div>
<div class="tip" id="fs46">val floatPU : BinaryPU&lt;float&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.floatPU</div>
<div class="tip" id="fs47">val asciiStringPU : BinaryPU&lt;string&gt;<br /><br />Full name: Pickler.asciiStringPU</div>
<div class="tip" id="fs48">val asciiCharPU : BinaryPU&lt;char&gt;<br /><br />Full name: Pickler.asciiCharPU</div>
<div class="tip" id="fs49">val asciiCharPU : BinaryPU&lt;char&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.asciiCharPU</div>
<div class="tip" id="fs50">val lengthPrefixedAscii : BinaryPU&lt;string&gt;<br /><br />Full name: Pickler.lengthPrefixedAscii</div>
<div class="tip" id="fs51">val lengthPrefixed : pa:BinaryPU&lt;char&gt; -&gt; BinaryPU&lt;string&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.lengthPrefixed</div>
<div class="tip" id="fs52">val nullTermAscii : BinaryPU&lt;string&gt;<br /><br />Full name: Pickler.nullTermAscii</div>
<div class="tip" id="fs53">val nullTerminated : pa:BinaryPU&lt;char&gt; -&gt; BinaryPU&lt;string&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.nullTerminated</div>
<div class="tip" id="fs54">val utf8PU : BinaryPU&lt;string&gt;<br /><br />Full name: Pickler.utf8PU</div>
<div class="tip" id="fs55">val io : IO.IOBuilder<br /><br />Full name: NovelFS.NovelIO.IOBuilders.io</div>
<div class="tip" id="fs56">val handle : BinaryHandle</div>
<div class="tip" id="fs57">module File<br /><br />from NovelFS.NovelIO</div>
<div class="tip" id="fs58">val openBinaryHandle : mode:FileMode -&gt; access:FileAccess -&gt; fName:Filename -&gt; IO&lt;BinaryHandle&gt;<br /><br />Full name: NovelFS.NovelIO.File.openBinaryHandle</div>
<div class="tip" id="fs59">type FileMode =<br />&#160;&#160;| CreateNew<br />&#160;&#160;| Create<br />&#160;&#160;| Open<br />&#160;&#160;| OpenOrCreate<br />&#160;&#160;| Truncate<br />&#160;&#160;| Append<br /><br />Full name: NovelFS.NovelIO.FileMode</div>
<div class="tip" id="fs60">union case FileMode.Open: FileMode</div>
<div class="tip" id="fs61">type FileAccess =<br />&#160;&#160;| Read<br />&#160;&#160;| Write<br />&#160;&#160;| ReadWrite<br /><br />Full name: NovelFS.NovelIO.FileAccess</div>
<div class="tip" id="fs62">union case FileAccess.Read: FileAccess</div>
<div class="tip" id="fs63">val assumeValidFilename : path:string -&gt; Filename<br /><br />Full name: NovelFS.NovelIO.File.assumeValidFilename</div>
<div class="tip" id="fs64">val unpickleIncr : pu:BinaryPU&lt;&#39;a&gt; -&gt; binaryHandle:BinaryHandle -&gt; IO&lt;&#39;a&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.unpickleIncr</div>
<div class="tip" id="fs65">union case FileMode.Create: FileMode</div>
<div class="tip" id="fs66">union case FileAccess.Write: FileAccess</div>
<div class="tip" id="fs67">val data : (string * float * int) list</div>
<div class="tip" id="fs68">val pickleIncr : pu:BinaryPU&lt;&#39;a&gt; -&gt; binaryHandle:BinaryHandle -&gt; value:&#39;a -&gt; IO&lt;unit&gt;<br /><br />Full name: NovelFS.NovelIO.BinaryPickler.BinaryPickler.pickleIncr</div>

        </div>
        <div class="span3">
          <img src="/NovelIO/img/logo.png" alt="F# Project" style="width:150px;margin:10px" />  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">NovelIO</li>
            <li><a href="/NovelIO/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/NovelIO">Get Library via NuGet</a></li>
            <li><a href="http://github.com/TheInnerLight/NovelIO">Source Code on GitHub</a></li>
            <li><a href="/NovelIO/license.html">License</a></li>
            <li><a href="/NovelIO/release-notes.html">Release Notes</a></li>
            
            <li class="nav-header">Getting started</li>
            <li><a href="/NovelIO/motivation.html">Motivation</a></li>
            <li><a href="/NovelIO/oopintro.html">From an OOP Perspective</a></li>
            <li><a href="/NovelIO/files.html">Working with Files</a></li>
            <li><a href="/NovelIO/pickler.html">Using the Pickler Combinator</a></li>

            <li class="nav-header">Documentation</li>
            <li><a href="/NovelIO/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/TheInnerLight/NovelIO"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
